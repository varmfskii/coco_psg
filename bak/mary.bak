	include "coco.inc"
	include "aypsg.inc"
	
	org $7000
	include "ssc.asm"
start:
	lda #$60
	ldx #screen
cls:
	sta ,x+
	cmpx #screen+$200
	bne cls

;;; initialize ay
	lbsr init
	pre
	lda #ay_e_coarse
	ldb #13
	lbsr control
	lda #ay_e_fine
	ldb #136
	lbsr control
	lda #ay_e_coarse
	lbsr control
	lda #ay_enable
	ldb #%00111000
	lbsr control

;;; setup irq routine
	orcc #$50		; disable interrupts
	lda pia0+1
	sta old+3
	anda #$fe
	sta pia0+1
	lda pia0+3
	sta old+4
	ora #$01
	sta pia0+3
	lda irqvec
	sta old
	lda #$7e
	sta irqvec
	ldx irqvec+1
	stx old+1
	ldx #interrupt
	stx irqvec+1
	andcc #$ef		; enable interrupts

;;; main program
	clra
mainlp:	
	inca

	;; top line
	ldx #screen
l@:	
	sta ,x+
	cmpx #screen+32
	bne l@

	;; right size
	ldx #screen+32+31
l@:
	sta ,x
	leax 32,x
	cmpx #screen+$200
	blt l@

	;; bottom line
	ldx #screen+32*15+31
l@:
	sta ,-x
	cmpx #screen+$1e0
	bne l@

	;; left side
	ldx #screen+14*32
l@:
	sta ,x
	leax -32,x
	cmpx #screen
	bne l@

	;; delay
	ldx #2048
l@:
	leax -1,x
	bne l@

	;; check if music is finished
	ldb done
	bne mainlp
	rts

interrupt:
	ldb pia0+2		; ack interrupt
	;; switch screen color
	ldb pia1+2
	eorb #$08
	stb pia1+2

	
	clr done
play0:	
	ldx voices
	beq play1
	inc done
	dec ,x
	bne play1
	leax 1,x
	ldb ,x+
	stb screen+32*2+7
	lda #ay_a_coarse
	lbsr control
	ldb ,x+
	stb screen+32*2+8
	lda #ay_a_fine
	lbsr control
	ldb ,x+
	stb screen+32*2+9
	lda #ay_a_amp
	lbsr control
	lda ,x
	bne skip0
	ldx #0
skip0:	
	stx voices
play1:	
	ldx voices+2
	beq play2
	inc done
	dec ,x
	bne play2
	leax 1,x
	ldb ,x+
	stb screen+32*2+15
	lda #ay_b_coarse
	lbsr control
	ldb ,x+
	stb screen+32*2+16
	lda #ay_b_fine
	lbsr control
	ldb ,x+
	stb screen+32*2+17
	lda #ay_b_amp
	lbsr control
	lda ,x
	bne skip1
	ldx #0
skip1:	
	stx voices+2
play2:
	ldx voices+4
	beq exit
	inc done
	dec ,x
	bne exit
	leax 1,x
	ldb ,x+
	stb screen+32*2+23
	lda #ay_c_coarse
	lbsr control
	ldb ,x+
	stb screen+32*2+24
	lda #ay_c_fine
	lbsr control
	ldb ,x+
	stb screen+32*2+25
	lda #ay_c_amp
	lbsr control
	lda ,x
	bne skip2
	ldx #0
skip2:	
	stx voices+4
exit:
	lda done
	bne next
	lda #ay_enable
	ldb #%00111111
	lbsr control
	;; post
	lda old
	sta irqvec
	ldx old+1
	stx irqvec+1
	lda old+3
	sta pia0+1
	lda old+4
	sta pia0+3
next:	
	ldb pia1+2
	eorb #$08
	stb pia1+2
	rti

voices:
	fdb voice0
	fdb voice1
	fdb voice2
voice0:
	fcb 1
	fcb 1,83,16,45
	fcb 1,125,16,45
	fcb 1,172,16,45
	fcb 1,125,16,45
	fcb 1,83,16,45
	fcb 1,83,16,45
	fcb 1,83,16,90
	fcb 1,125,16,45
	fcb 1,125,16,45
	fcb 1,125,16,90
	fcb 1,83,16,45
	fcb 1,19,16,45
	fcb 1,19,16,90
	fcb 1,83,16,45
	fcb 1,125,16,45
	fcb 1,172,16,45
	fcb 1,125,16,45
	fcb 1,83,16,45
	fcb 1,83,16,45
	fcb 1,83,16,45
	fcb 1,83,16,45
	fcb 1,125,16,45
	fcb 1,125,16,45
	fcb 1,83,16,45
	fcb 1,125,16,45
	fcb 1,172,16,180
	fcb 0,0,0,0
voice1:
	fcb 1
	fcb 0,0,0,0
	fcb 3,88,16,90
	fcb 4,116,16,90
	fcb 3,88,16,90
	fcb 4,116,16,90
	fcb 4,116,16,90
	fcb 3,136,16,90
	fcb 3,88,16,90
	fcb 4,116,16,90
	fcb 3,88,16,90
	fcb 4,116,16,90
	fcb 3,88,16,90
	fcb 4,116,16,90
	fcb 4,116,16,90
	fcb 3,136,16,90
	fcb 3,88,16,180
	fcb 0,0,0,0
voice2:
	fcb 1
	fcb 0,0,0,0
done:
	fcb $ff
old:
	rmb 5
	
	end start
	
